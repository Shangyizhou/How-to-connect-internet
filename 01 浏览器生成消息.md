## 浏览器生成消息

**需要解决的问题**

- 我们想浏览器中输入网址，浏览器会工作对网址进行解析并生成请求消息。我们需要知道浏览器是如何解析网址的，并得知请求消息报文的样子。
- 请求消息生成后，浏览器会委托操作系统向Web服务器发送请求，那么我们的浏览器需要告诉OS接收方的IP地址是多少，因此我们需要得知浏览器是如何得知Web服务器的IP地址的。即，DNS服务器是如何查询IP地址的。
- 我们将会对DNS服务器进行进一步的理解，上万台的DNS服务器是如何接力才能查询到IP地址的
- 查询完成后，浏览器是如何委托OS将消息报文发送给服务器的，这个委托是如何完成的。

### 生成HTTP请求消息

#### 输入网址

我们输入的网址，比如`http://...`这一串，我们叫做`URL(Uniform Resource Locator，统一资源定位符)`

但实际上除了`“http:”`，网址还可以以其他一些文字开头，例如`“ftp:”“file:” “mailto:”C` 等。 之所以有各种各样的 URL，是因为尽管我们通常是使用浏览器来访问 Web 服务器的，但实际上浏览器并不只有这一个功能，它也可以用来在 FTP服务器上下载和上传文件，同时也具备电子邮件客户端的功能。**可以说，浏览器是一个具备多种客户端功能的综合性客户端软件**，因此它需要 一些东西来判断应该使用其中哪种功能来访问相应的数据，比如访问 Web 服务器时用`“http:”`，而访问 FTP 服务器时用`“ftp:”`

<img src="https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163521479.png" alt="image-20211117163521479"  />

```C
http://glasscom.com/dir/file1.htm
```

#### 浏览器解析URL

![image-20211117163756704](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163756704.png)

![image-20211117163800318](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163800318.png)

#### HTTP的基本思路

解析完 URL 之后，我们就知道应该要访问的目标在哪里了。接下来， 浏览器会使用 HTTP 协议来访问 Web 服务器，我们需要先介绍一下HTTP协议

![image-20211117163951600](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163951600.png)

首先，客户端会向服务器发送请求消息。**请求消息中包含的内容是“对什么(URI)”和“进行怎样的操作(方法)”两个部分。**一般来说，URI 的内容是一个存放网页数据的文件名或者是一个 CGI 程序的文件名，例如`“/dir1/file1.html”` `“/dir1/program1.cgi”`等 。不过，URI 不仅限于此，也可以直接使用`“http:” `开头的 URL来作为 URI。换句话说就是，这里可以写各种访问目标，而这些访问目标统称为 URI。 

方法表示需要让 Web 服务器完成怎样的工作，其中典型的例子包括读取 URI 表示的数据、 将客户端输入的数据发送给 URI 表示的程序等。表 1.1 列举了主要的方法， 通过这张表大家应该能够理解通过方法可以执行怎样的操作。

<img src="https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117164314068.png" alt="image-20211117164314068" style="zoom:80%;" />

> URI表示访问目标
>
> 方法表示让 Web 服务器完成怎样的工作

#### Web服务器收到请求消息后的处理

收到请求消息之后，Web 服务器会对其中的内容进行解析，通过 URI 和方法来判断“对什么”“进行怎样的操作”，并根据这些要求来完成自己的工作，然后将结果存放在响应消息中。在响应消息的开头有一个状态码， 它用来表示操作的执行结果是成功还是发生了错误。

响应消息会被发送回客户端，客户端收到之后，浏览器会从消息中读出所需的数据并显示在屏幕上。到这里，HTTP的整个工作就完成了。

如果只有 GET 和 POST 方法，我们就只能从 Web 服务器中获取网页数据，以及将网 页输入框中的信息发送给 Web 服务器，而有了 PUT 和 DELETE 方法，就 能够从客户端修改或者删除 Web 服务器上的文件。

#### 生成HTTP请求消息

![image-20211117170042811](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117170042811.png)

![image-20211117170721408](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117170721408.png)

```C
GET /cgi/sample.cgi?Field1=ABCDEFG&SendButton=SEND HTTP/1.1
方法 URI HTTP的版本号
```

第二行是消息头，尽管通过第一行我们就可以大致理解请求的内容，但有些情况下还需要一些额外的详细信息，而消息头的功能就是用来 存放这些信息。**消息头的规格中定义了很多项目，如日期、客户端支持的 数据类型、语言、压缩格式、客户端和服务器的软件名称和版本、数据有效期和最后更新时间等。**

#### 发送请求后会收到响应

```C
状态码   含义
1xx 	告知请求的处理进度和情况
2xx 	成功
3xx 	表示需要进一步操作
4xx 	客户端错误
5xx 	服务器错误
```

由于每条请求消息中只能写 1 个 URI，所以每次只能获取 1 个文件， 如果需要获取多个文件，必须对每个文件单独发送 1 条请求。

> 比如 1 个 网页中包含 3 张图片，那么获取网页加上获取图片，一共需要向 Web 服务器发送 4 条请求

### 向DNS服务器查询Web服务器的IP地址

浏览器可以解析网址并生成HTTP消息，但它本身不具备将消息发送到网络的功能，需委托OS实现。那么我们让OS发送给Web Server，我们就需要查询到服务器的IP地址，否则OS不知道发送目的。

#### IP地址

我们的局域网是基于TCP/IP的思路设计的，由小的子网再通过路由器连成一个大的网络，子网又是由集线器连接起来的几台计算机（可将其看作一个单位）。发出的消息通过子网的集线器到达最近的路由器，路由器再根据消息目的地判断下一个路由器位置，将消息发到下一个路由器（这其中经过了集线器才被发到了下一个路由器），直至目的地。

![image-20211117172407735](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117172407735.png)

在网络中，所有的设备都会被分配一个地址。由网络号和主机号组成，整个地址称为IP地址。

实际的 IP 地址是一串 32 比特的数字，按照 8 比特（1 字节）为一组分成 4 组，分别用十进制表示然后再用圆点隔开。这就是我们平常经常见到的 IP 地址格式，但仅凭这一 串数字我们无法区分哪部分是网络号，哪部分是主机号。

在 IP 地址的规则中，**网络号和主机号连起来总共是 32 比特，但这两部分的具体结构是不固定的**。在组建网络时，用户可以自行决定它们之间的分配关系，因此，我们还需要另外的附加信息来表示 IP 地址的内部结构，那就是子网掩码。

子网掩码为 1 的部分表示网络号，子网掩码为 0 的部分表示主机 号。将子网掩码按照和 IP 地址一样的方式以每 8 比特为单位用圆点分组后 写在 IP 地址的右侧。计算机发送数据要判断是否在同一个网络段，就会通过子网掩码来判断，在同一个网络段可以直接发送数据。

![image-20211118112503141](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118112503141.png)

主机号部分全部为 0 代表整个子网而不是子网中的某台设备。此外，主机号部分全部为 1 代表向子网上所有设备发送包，即广播。

#### 域名和IP地址互用

用户查询使用域名，路由器查询使用IP，这样子人们方便记忆，计算机也可以高效率查找匹配，因为域名字节数会多于IP地址。

#### Socket库提供查询IP地址的功能

查询IP地址只需向DNS服务器询问即可，比如询问`www. lab.glasscom.com`的IP地址。向DNS服务器发出查询，也就是向 DNS 服务器发送查询消息，并接收服务器返回的响应消息。那么可以得出，我们必然需要有DNS客户端，来接收消息。

DNS客户端称为DNS解析器，负责执行域名的解析。解析器是一段程序，并且在操作系统的socket库中。

#### 使用解析器向DNS服务器发出查询

调用程序，写入请求解析的域名即可得到对应的IP地址

![image-20211118113901993](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118113901993.png)

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服 务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。浏览器在Web 服务器发送消息时，只要从该内存地址取出 IP 地址，并将它与 HTTP 请求消息一起交给操作系统就可以了。

![image-20211118114318392](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118114318392.png)

向 DNS 服务器发送消息时，我们当然也需要知道 DNS 服务器的 IP 地址。只不过这个 IP 地址是作为 TCP/IP 的一个设置项目事先设置好的，不需要再去查询了。

如下是Windows设置DNS服务器IP的例子

![image-20211118114951909](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118114951909.png)

## 全世界DNS服务器的大接力

#### DNS服务器的基本工作

来自客户端的查询消息包含以下三种

- 域名
  - 服务器、邮件服务器（邮件地址中 @ 后面的部分）的名称
- class
  - 在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN
- 记录类型
  - 表示域名对应何种类型的记录。例如，当类型为 A 时，表示域名对应的是 IP 地址；当类型为 MX 时，表示域名对应的是邮件服务器。对于不同的记录类型，服务器向客户端返回的信息也会不同 

![image-20211118122107062](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118122107062.png)

```c
 www.lab.glasscom.com 
```

比如查询这个域名对应的IP地址，客户端向DNS服务器发送以下查询消息

```C
域名 = www.lab.glasscom.com
Class = IN
记录类型 = A
```

然后，DNS 服务器会从已有的记录中查找域名、Class 和记录类型全 部匹配的记录。

在查询 IP 地址时我们使用 A 这个记录类型，而查询邮件服务器时则要使用 MX 类型。这是因为在 DNS 服务器上，IP 地址是保存在 A 记录中 的，而邮件服务器则是保存在 MX 记录中的。

比如查询邮件`tone@glasscom.com`，我们需要知道这个地址对应的邮件服务器，需要提供`@`后面的一串名称。客户端向DNS服务器发送以下消息

```C
域名 = glasscom.com
Class = IN
记录类型 = MX
```

#### 域名的层次结构

互联网中服务器数量过多，一个DNS服务器肯定不够存储。所以需要多台DNS服务器相互配合，查询信息。

**DNS 服务器中的所有信息都是按照域名以分层次的结构来保存的。**

比如` www.lab.glasscom.com `这个域名如果按照公司里的组织结构来说，大概就是 com 事业集团 glasscom 部 lab 科的 www” 这样。其中，相当于一个层级的部分称为域。因此，com 域的下一层是 glasscom 域，再下一层是 lab 域，再下面才是 www 这个名字。

一般来讲，一个域的信息是作为一个整体存储，不能将一个域岔开存放在多台DNS服务器中（也有一个DNS服务器存储多个域的情况，但不增设复杂情况）

#### 寻找相应的DNS服务器并获取IP地址

这里的关键在于如何找到我们要访问的 Web 服务器的信息归哪一台 DNS 服务器管。DNS服务器有一个规律，负责管理下级域的DNS服务器的IP地址注册到它们的上级DNS服务器中，所以我们可以自下而上的寻找包含我们信息的DNS服务器。

**根域DNS服务器**

在互联网中，com，jp的上面还有一层根域，通常在后面用一个`.`表示。` www.lab.glasscom.com.`

，一般忽略最后的点。根域服务器保存着`com` `jp`等DNS服务器的信息，我们也可以从根域开始向下寻找任意的DNS服务器。我们将根域的 DNS 服务器信息保 存在互联网中所有的 DNS 服务器中。这样一来，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了，然后再一路向下寻找别的DNS服务器。

分配给根域服务器的IP地址较少，所以一般DNS服务器初始化配置的时候就可以获得这些地址。

![image-20211118143203499](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118143203499.png)

![image-20211118143924503](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118143924503.png)

#### 通过缓存加快DNS服务器的响应

有时候并不需要从最上级的根域开始查找，因为 DNS 服务器有一 个缓存 A 功能，可以记住之前查询过的域名。如果要查询的域名和相关信息已 经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓存的位置开 始向下进行。相比每次都从根域找起来说，缓存可以减少查询所需的时间。

查询域名不存在的情况，也会被记录到缓存中。

但如果，缓存中的信息实际上经过了更改以后，我们还是直接套用缓存的结果，那么会得到错误的IP地址。因此，缓存是有有效期的。而且，在对查询进行响应时，DNS 服务器也会告知客户端这一响应的结果是来自缓存中还是来自负责管理该域名的 DNS 服务器。

### 委托协议栈发送消息

```C
SOCKET;
BIND;
ACCEPT;
CONNECT;
C
```

