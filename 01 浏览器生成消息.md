## 浏览器生成消息

**需要解决的问题**

- 我们想浏览器中输入网址，浏览器会工作对网址进行解析并生成请求消息。我们需要知道浏览器是如何解析网址的，并得知请求消息报文的样子。
- 请求消息生成后，浏览器会委托操作系统向Web服务器发送请求，那么我们的浏览器需要告诉OS接收方的IP地址是多少，因此我们需要得知浏览器是如何得知Web服务器的IP地址的。即，DNS服务器是如何查询IP地址的。
- 我们将会对DNS服务器进行进一步的理解，上万台的DNS服务器是如何接力才能查询到IP地址的
- 查询完成后，浏览器是如何委托OS将消息报文发送给服务器的，这个委托是如何完成的。

### 生成HTTP请求消息

#### 输入网址

我们输入的网址，比如`http://...`这一串，我们叫做`URL(Uniform Resource Locator，统一资源定位符)`

但实际上除了`“http:”`，网址还可以以其他一些文字开头，例如`“ftp:”“file:” “mailto:”C` 等。 之所以有各种各样的 URL，是因为尽管我们通常是使用浏览器来访问 Web 服务器的，但实际上浏览器并不只有这一个功能，它也可以用来在 FTP服务器上下载和上传文件，同时也具备电子邮件客户端的功能。**可以说，浏览器是一个具备多种客户端功能的综合性客户端软件**，因此它需要 一些东西来判断应该使用其中哪种功能来访问相应的数据，比如访问 Web 服务器时用`“http:”`，而访问 FTP 服务器时用`“ftp:”`

<img src="https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163521479.png" alt="image-20211117163521479"  />

```C
http://glasscom.com/dir/file1.htm
```

#### 浏览器解析URL

![image-20211117163756704](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163756704.png)

![image-20211117163800318](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163800318.png)

#### HTTP的基本思路

解析完 URL 之后，我们就知道应该要访问的目标在哪里了。接下来， 浏览器会使用 HTTP 协议来访问 Web 服务器，我们需要先介绍一下HTTP协议

![image-20211117163951600](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117163951600.png)

首先，客户端会向服务器发送请求消息。**请求消息中包含的内容是“对什么(URI)”和“进行怎样的操作(方法)”两个部分。**一般来说，URI 的内容是一个存放网页数据的文件名或者是一个 CGI 程序的文件名，例如`“/dir1/file1.html”` `“/dir1/program1.cgi”`等 。不过，URI 不仅限于此，也可以直接使用`“http:” `开头的 URL来作为 URI。换句话说就是，这里可以写各种访问目标，而这些访问目标统称为 URI。 

方法表示需要让 Web 服务器完成怎样的工作，其中典型的例子包括读取 URI 表示的数据、 将客户端输入的数据发送给 URI 表示的程序等。表 1.1 列举了主要的方法， 通过这张表大家应该能够理解通过方法可以执行怎样的操作。

<img src="https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117164314068.png" alt="image-20211117164314068" style="zoom:80%;" />

> URI表示访问目标
>
> 方法表示让 Web 服务器完成怎样的工作

#### Web服务器收到请求消息后的处理

收到请求消息之后，Web 服务器会对其中的内容进行解析，通过 URI 和方法来判断“对什么”“进行怎样的操作”，并根据这些要求来完成自己的工作，然后将结果存放在响应消息中。在响应消息的开头有一个状态码， 它用来表示操作的执行结果是成功还是发生了错误。

响应消息会被发送回客户端，客户端收到之后，浏览器会从消息中读出所需的数据并显示在屏幕上。到这里，HTTP的整个工作就完成了。

如果只有 GET 和 POST 方法，我们就只能从 Web 服务器中获取网页数据，以及将网 页输入框中的信息发送给 Web 服务器，而有了 PUT 和 DELETE 方法，就 能够从客户端修改或者删除 Web 服务器上的文件。

#### 生成HTTP请求消息

![image-20211117170042811](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117170042811.png)

![image-20211117170721408](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117170721408.png)

```C
GET /cgi/sample.cgi?Field1=ABCDEFG&SendButton=SEND HTTP/1.1
方法 URI HTTP的版本号
```

第二行是消息头，尽管通过第一行我们就可以大致理解请求的内容，但有些情况下还需要一些额外的详细信息，而消息头的功能就是用来 存放这些信息。**消息头的规格中定义了很多项目，如日期、客户端支持的 数据类型、语言、压缩格式、客户端和服务器的软件名称和版本、数据有效期和最后更新时间等。**

#### 发送请求后会收到响应

```C
状态码   含义
1xx 	告知请求的处理进度和情况
2xx 	成功
3xx 	表示需要进一步操作
4xx 	客户端错误
5xx 	服务器错误
```

由于每条请求消息中只能写 1 个 URI，所以每次只能获取 1 个文件， 如果需要获取多个文件，必须对每个文件单独发送 1 条请求。

> 比如 1 个 网页中包含 3 张图片，那么获取网页加上获取图片，一共需要向 Web 服务器发送 4 条请求

### 向DNS服务器查询Web服务器的IP地址

浏览器可以解析网址并生成HTTP消息，但它本身不具备将消息发送到网络的功能，需委托OS实现。那么我们让OS发送给Web Server，我们就需要查询到服务器的IP地址，否则OS不知道发送目的。

#### IP地址

我们的局域网是基于TCP/IP的思路设计的，由小的子网再通过路由器连成一个大的网络，子网又是由集线器连接起来的几台计算机（可将其看作一个单位）。发出的消息通过子网的集线器到达最近的路由器，路由器再根据消息目的地判断下一个路由器位置，将消息发到下一个路由器（这其中经过了集线器才被发到了下一个路由器），直至目的地。

![image-20211117172407735](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211117172407735.png)

在网络中，所有的设备都会被分配一个地址。由网络号和主机号组成，整个地址称为IP地址。

实际的 IP 地址是一串 32 比特的数字，按照 8 比特（1 字节）为一组分成 4 组，分别用十进制表示然后再用圆点隔开。这就是我们平常经常见到的 IP 地址格式，但仅凭这一 串数字我们无法区分哪部分是网络号，哪部分是主机号。

在 IP 地址的规则中，**网络号和主机号连起来总共是 32 比特，但这两部分的具体结构是不固定的**。在组建网络时，用户可以自行决定它们之间的分配关系，因此，我们还需要另外的附加信息来表示 IP 地址的内部结构，那就是子网掩码。

子网掩码为 1 的部分表示网络号，子网掩码为 0 的部分表示主机 号。将子网掩码按照和 IP 地址一样的方式以每 8 比特为单位用圆点分组后 写在 IP 地址的右侧。计算机发送数据要判断是否在同一个网络段，就会通过子网掩码来判断，在同一个网络段可以直接发送数据。

![image-20211118112503141](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118112503141.png)

主机号部分全部为 0 代表整个子网而不是子网中的某台设备。此外，主机号部分全部为 1 代表向子网上所有设备发送包，即广播。

#### 域名和IP地址互用

用户查询使用域名，路由器查询使用IP，这样子人们方便记忆，计算机也可以高效率查找匹配，因为域名字节数会多于IP地址。

#### Socket库提供查询IP地址的功能

查询IP地址只需向DNS服务器询问即可，比如询问`www. lab.glasscom.com`的IP地址。向DNS服务器发出查询，也就是向 DNS 服务器发送查询消息，并接收服务器返回的响应消息。那么可以得出，我们必然需要有DNS客户端，来接收消息。

DNS客户端称为DNS解析器，负责执行域名的解析。解析器是一段程序，并且在操作系统的socket库中。

#### 使用解析器向DNS服务器发出查询

调用程序，写入请求解析的域名即可得到对应的IP地址

![image-20211118113901993](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118113901993.png)

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服 务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。浏览器在Web 服务器发送消息时，只要从该内存地址取出 IP 地址，并将它与 HTTP 请求消息一起交给操作系统就可以了。

![image-20211118114318392](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211118114318392.png)
